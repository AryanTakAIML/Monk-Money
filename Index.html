<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monk Money</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  </head>

  <body>
    <div class="app">
      <header>
        <div>
          <h1>Monk Money</h1>
          <p>Track your income and expenses.</p>
        </div>
      </header>

      <section class="cards" id="summary"></section>

      <section class="layout">
        <div class="panel">
          <h2>Add transaction</h2>

          <form id="f">
            <div>
              <label>Type</label>
              <div class="grid-two">
                <select id="t">
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                </select>

                <input type="date" id="d">
              </div>
            </div>

            <div class="grid-two">
              <div>
                <label>Category</label>
                <select id="c">
                  <option disabled selected>Select</option>
                  <option value="Salary">Salary</option>
                  <option value="Savings">Savings</option>
                  <option value="Food">Food</option>
                  <option value="Housing">Housing</option>
                  <option value="Transport">Transport</option>
                  <option value="Shopping">Shopping</option>
                  <option value="Health">Health</option>
                  <option value="Investments">Investments</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div>
                <label>Amount</label>
                <input type="number" id="a" min="0.01" step="0.01">
              </div>
            </div>

            <div>
              <label>Note</label>
              <textarea id="n" rows="3"></textarea>
            </div>

            <button class="primary" type="submit">Save</button>
          </form>
        </div>

        <div class="panel">
          <div class="transactions-header">
            <h2>Activity</h2>
            <select id="filter">
              <option value="all">All</option>
              <option value="30">Last 30 days</option>
              <option value="7">Last 7 days</option>
              <option value="today">Today</option>
            </select>
          </div>

          <div class="table-wrapper" id="wrap"></div>
        </div>
      </section>

      <section class="panel" style="margin-top:20px">
        <h2>Spending snapshot</h2>
        <div id="break"></div>
      </section>
    </div>

    <template id="row">
      <tr>
        <td class="tag type"></td>
        <td class="desc"></td>
        <td class="cat"></td>
        <td class="note"></td>
        <td class="amount"></td>
        <td class="date"></td>
      </tr>
    </template>

    <script>
      const $ = (x) => document.querySelector(x);

      let state = { all: [], show: [] };

      function money(v){
        return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(v);
      }

      async function load(){
        let r = await fetch("/all");
        let data = await r.json();
        state.all = data;
        state.show = data;
        run();
      }

      function apply(){
        let f = $("#filter").value;

        if(f=="all"){
          state.show = [...state.all];
          return;
        }

        let today = new Date();
        if(f=="today"){
          let d = today.toISOString().slice(0,10);
          state.show = state.all.filter(x => x.date == d);
          return;
        }

        let days = Number(f);
        let cut = new Date();
        cut.setDate(today.getDate() - days);

        state.show = state.all.filter(x => new Date(x.date) >= cut);
      }

      function sum(){
        let inc = 0, exp = 0;

        state.show.forEach(x=>{
          if(x.type=="income") inc += Number(x.amount);
          else exp += Number(x.amount);
        });

        let bal = inc - exp;
        let br = inc>0 ? Math.round((exp/inc)*100) : 0;

        $("#summary").innerHTML = `
          <article class="card">
            <h3>Net balance</h3>
            <div class="value">${money(bal)}</div>
            <span class="pill ${bal>=0?"success":"danger"}">${bal>=0?"In green":"In red"}</span>
          </article>

          <article class="card">
            <h3>Total income</h3>
            <div class="value">${money(inc)}</div>
            <span class="pill success">Steady inflow</span>
          </article>

          <article class="card">
            <h3>Total expenses</h3>
            <div class="value">${money(exp)}</div>
            <span class="pill danger">Burn ${br}%</span>
          </article>
        `;
      }

      function table(){
        let w = $("#wrap");

        if(state.show.length==0){
          w.innerHTML = "<div class='empty'>No data</div>";
          return;
        }

        let t = document.createElement("table");
        t.className = "transactions";

        t.innerHTML = `
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Category</th>
              <th>Note</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        let body = t.querySelector("tbody");
        let temp = $("#row");

        state.show.forEach(x=>{
          let r = temp.content.cloneNode(true);

          r.querySelector(".type").textContent = x.type=="income"?"Income":"Expense";
          r.querySelector(".type").classList.add(x.type=="income"?"success":"danger");
          r.querySelector(".desc").textContent = x.category;
          r.querySelector(".cat").textContent = x.category;
          r.querySelector(".note").textContent = x.note || "-";
          r.querySelector(".amount").textContent = money(x.type=="income"?x.amount:-x.amount);
          r.querySelector(".date").textContent = x.date;

          body.appendChild(r);
        });

        w.innerHTML = "";
        w.appendChild(t);
      }

      function breakdown(){
        let arr = state.show.filter(x=>x.type=="expense");

        if(arr.length==0){
          $("#break").innerHTML = "<div class='empty'>Add expenses</div>";
          return;
        }

        let map = {};

        arr.forEach(x=>{
          map[x.category] = (map[x.category]||0) + Number(x.amount);
        });

        let tot = Object.values(map).reduce((a,b)=>a+b,0);

        $("#break").innerHTML = Object.entries(map).map(([cat,val])=>{
          let p = val / tot;
          return `
            <div>
              <div class="transactions-header" style="margin-bottom:6px">
                <strong>${cat}</strong>
                <span>${money(val)} Â· ${(p*100).toFixed(0)}%</span>
              </div>
              <div class="bar animate" style="--value:${p}">
                <span></span>
              </div>
            </div>
          `;
        }).join("");
      }

      function run(){
        apply();
        sum();
        table();
        breakdown();
      }

      $("#f").addEventListener("submit", async (e)=>{
        e.preventDefault();

        let tx = {
          type: $("#t").value,
          category: $("#c").value,
          note: $("#n").value,
          amount: Number($("#a").value),
          date: $("#d").value || new Date().toISOString().slice(0,10)
        };

        if(tx.amount <= 0){
          alert("enter valid amount");
          return;
        }

        await fetch("/add",{
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(tx)
        });

        $("#f").reset();
        load();
      });

      $("#filter").addEventListener("change", run);

      load();
    </script>
  </body>
</html>
